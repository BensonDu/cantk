function isArrayish(t){if(!t){return false}return t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&t.constructor.name!=="String")}var concat=Array.prototype.concat;var slice=Array.prototype.slice;function swizzle(t){var e=[];for(var r=0,a=t.length;r<a;r++){var i=t[r];if(isArrayish(i)){e=concat.call(e,slice.call(i))}else{e.push(i)}}return e}swizzle.wrap=function(t){return function(){return t(swizzle(arguments))}};var colorNames={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};var reverseNames={};for(var name in colorNames){if(colorNames.hasOwnProperty(name)){reverseNames[colorNames[name]]=name}}var cs={to:{}};cs.get=function(t){var e=t.substring(0,3).toLowerCase();var r;var a;switch(e){case"hsl":r=cs.get.hsl(t);a="hsl";break;case"hwb":r=cs.get.hwb(t);a="hwb";break;default:r=cs.get.rgb(t);a="rgb";break}if(!r){return null}return{model:a,value:r}};cs.abbrreg=/^#([a-fA-F0-9]{3})$/;cs.hexreg=/^#([a-fA-F0-9]{6})$/;cs.rgbareg=/^rgba?\(\s*([+-]?\d+)\s*,\s*([+-]?\d+)\s*,\s*([+-]?\d+)\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)$/;cs.perreg=/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,\s*([+-]?[\d\.]+)\%\s*,\s*([+-]?[\d\.]+)\%\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)$/;cs.keywordreg=/(\D+)/;cs.cache={};cs.get.rgb=function(t){var e=cs.cache[t];if(!e){e=cs.get.rgbSlow(t);cs.cache[t]=e}return e};cs.get.rgbSlow=function(t){var e;var r;var a=[0,0,0,1];if(!t){return a}if(r=t.match(cs.abbrreg)){r=r[1];for(e=0;e<3;e++){a[e]=parseInt(r[e]+r[e],16)}}else if(r=t.match(cs.hexreg)){r=r[1];for(e=0;e<3;e++){var i=e*2;a[e]=parseInt(r.slice(i,i+2),16)}}else if(r=t.match(cs.rgbareg)){for(e=0;e<3;e++){a[e]=parseInt(r[e+1],0)}if(r[4]){a[3]=parseFloat(r[4])}}else if(r=t.match(cs.perreg)){for(e=0;e<3;e++){a[e]=Math.round(parseFloat(r[e+1])*2.55)}if(r[4]){a[3]=parseFloat(r[4])}}else if(r=t.match(cs.keywordreg)){if(r[1]==="transparent"){return[0,0,0,0]}a=colorNames[r[1]];if(!a){return null}a[3]=1;return a}for(e=0;e<a.length;e++){a[e]=clamp(a[e],0,255)}a[3]=clamp(a[3],0,1);return a};cs.get.hsl=function(t){if(!t){return null}var e=/^hsla?\(\s*([+-]?\d*[\.]?\d+)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)/;var r=t.match(e);if(r){var a=parseFloat(r[4]);var i=(parseFloat(r[1])%360+360)%360;var n=clamp(parseFloat(r[2]),0,100);var s=clamp(parseFloat(r[3]),0,100);var o=clamp(isNaN(a)?1:a,0,1);return[i,n,s,o]}};cs.get.hwb=function(t){if(!t){return null}var e=/^hwb\(\s*([+-]?\d*[\.]?\d+)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)/;var r=t.match(e);if(r){var a=parseFloat(r[4]);var i=(parseFloat(r[1])%360+360)%360;var n=clamp(parseFloat(r[2]),0,100);var s=clamp(parseFloat(r[3]),0,100);var o=clamp(isNaN(a)?1:a,0,1);return[i,n,s,o]}};cs.to.hex=function(t){return"#"+hexDouble(t[0])+hexDouble(t[1])+hexDouble(t[2])};cs.to.rgb=function(){var t=swizzle(arguments);return t.length<4||t[3]===1?"rgb("+t[0]+", "+t[1]+", "+t[2]+")":"rgba("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"};cs.to.rgb.percent=function(){var t=swizzle(arguments);var e=Math.round(t[0]/255*100);var r=Math.round(t[1]/255*100);var a=Math.round(t[2]/255*100);return t.length<4||t[3]===1?"rgb("+e+"%, "+r+"%, "+a+"%)":"rgba("+e+"%, "+r+"%, "+a+"%, "+t[3]+")"};cs.to.hsl=function(){var t=swizzle(arguments);return t.length<4||t[3]===1?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"};cs.to.hwb=function(){var t=swizzle(arguments);var e="";if(t.length>=4&&t[3]!==1){e=", "+t[3]}return"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"};cs.to.keyword=function(t){return reverseNames[t.slice(0,3)]};function clamp(t,e,r){return Math.min(Math.max(e,t),r)}function hexDouble(t){var e=t.toString(16).toUpperCase();return e.length<2?"0"+e:e}function Int16DataBuffer(t){this.size=0;this.capacity=t;this.buffer=new ArrayBuffer(t*2);this.init16Buffer=new Int16Array(this.buffer)}Int16DataBuffer.prototype.extendTo=function(t){var e=new ArrayBuffer(t*2);var r=new Int16Array(e);r.set(this.init16Buffer,0);this.capacity=t;this.buffer=e;this.init16Buffer=r};Int16DataBuffer.prototype.extendIfFull=function(t){if(this.size+t>this.capacity){this.extendTo(Math.round(this.capacity*1.2)+t)}};Int16DataBuffer.prototype.pushX=function(){var t=arguments;var e=t.length;var r=this.size;this.extendIfFull(e);this.size+=e;var a=this.init16Buffer;for(var i=0;i<e;i++,r++){a[r]=t[i]}return this};Int16DataBuffer.prototype.push1=function(t){this.extendIfFull(1);this.init16Buffer[this.size++]=t;return this};Int16DataBuffer.prototype.push2=function(t,e){this.extendIfFull(2);this.init16Buffer[this.size++]=t;this.init16Buffer[this.size++]=e;return this};Int16DataBuffer.prototype.push3=function(t,e,r){this.extendIfFull(3);this.init16Buffer[this.size++]=t;this.init16Buffer[this.size++]=e;this.init16Buffer[this.size++]=r;return this};Int16DataBuffer.prototype.push4=function(t,e,r,a){this.extendIfFull(4);this.init16Buffer[this.size++]=t;this.init16Buffer[this.size++]=e;this.init16Buffer[this.size++]=r;this.init16Buffer[this.size++]=a;return this};Int16DataBuffer.prototype.push5=function(t,e,r,a,i){this.extendIfFull(5);this.init16Buffer[this.size++]=t;this.init16Buffer[this.size++]=e;this.init16Buffer[this.size++]=r;this.init16Buffer[this.size++]=a;this.init16Buffer[this.size++]=i;return this};Int16DataBuffer.prototype.push6=function(t,e,r,a,i,n){this.extendIfFull(6);this.init16Buffer[this.size++]=t;this.init16Buffer[this.size++]=e;this.init16Buffer[this.size++]=r;this.init16Buffer[this.size++]=a;this.init16Buffer[this.size++]=i;this.init16Buffer[this.size++]=n;return this};Int16DataBuffer.prototype.reset=function(){this.size=0};Int16DataBuffer.prototype.getReadBuffer=function(){var t=new Int16Array(this.buffer,0,this.size);t.size=this.size;return t};Int16DataBuffer.prototype.getWriteBuffer=function(t){this.extendIfFull(t);var e=this.init16Buffer;return e};Int16DataBuffer.prototype.getBufferType=function(){return"init16"};Int16DataBuffer.prototype.getElementBytes=function(){return 2};Int16DataBuffer.prototype.dup=function(){var t=Int16DataBuffer.create(this.size);var e=this.size;t.size=this.size;var r=this.init16Buffer;var a=t.init16Buffer;for(var i=0;i<e;i++){a[i]=r[i]}return t};Int16DataBuffer.create=function(t){var e=new Int16DataBuffer(t);return e};Int16DataBuffer.prototype.dump=function(){var t=this.size;var e=this.init16Buffer;console.log(this.size+" "+this.capacity+" "+this.getBufferType()+" "+this.getElementBytes());console.log(Array.prototype.join.call(e,","))};Int16DataBuffer.test=function(){var t=Int16DataBuffer.create(4);t.pushX(1,2,3,3,5,6,7,8,9,10,11);t.dump();var e=t.getReadBuffer();console.log("buffer("+e.length+")["+Array.prototype.join.call(e,",")+"]")};Int16DataBuffer.test();(function(t){"use strict";function e(t,e){var i,n,s,o,h,l,u;for(n=1;n<=8;n*=2){i=[];s=t[t.length-1];o=!(a(s,e)&n);for(h=0;h<t.length;h++){l=t[h];u=!(a(l,e)&n);if(u!==o)i.push(r(s,l,n,e));if(u)i.push(l);s=l;o=u}t=i;if(!t.length)break}return i}function r(t,e,r,a){return r&8?[t[0]+(e[0]-t[0])*(a[3]-t[1])/(e[1]-t[1]),a[3]]:r&4?[t[0]+(e[0]-t[0])*(a[1]-t[1])/(e[1]-t[1]),a[1]]:r&2?[a[2],t[1]+(e[1]-t[1])*(a[2]-t[0])/(e[0]-t[0])]:r&1?[a[0],t[1]+(e[1]-t[1])*(a[0]-t[0])/(e[0]-t[0])]:null}function a(t,e){var r=0;if(t[0]<e[0])r|=1;else if(t[0]>e[2])r|=2;if(t[1]<e[1])r|=4;else if(t[1]>e[3])r|=8;return r}Math.polygonclip=e;console.log(this)})(this);var result=Math.polygonclip([[10,-10],[10,30],[20,30],[20,-10]],[0,0,20,20]);console.log(result);(function(){var t=[];for(var e=0;e<360;e++){var r=e/57.2957;t.push(Math.sin(r)+1e-6)}Math.sinFast=function(e){var r=(e*57.2957>>0)%360;if(r<0){r+=360}return t[r]};Math.cosFast=function(t){return Math.sinFast(t+Math.PI*.5)}})();"use strict";var glMatrix={};glMatrix.EPSILON=1e-6;glMatrix.ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;glMatrix.RANDOM=Math.random;glMatrix.ENABLE_SIMD=false;glMatrix.SIMD_AVAILABLE=glMatrix.ARRAY_TYPE===this.Float32Array&&"SIMD"in this;glMatrix.USE_SIMD=glMatrix.ENABLE_SIMD&&glMatrix.SIMD_AVAILABLE;glMatrix.setMatrixArrayType=function(t){glMatrix.ARRAY_TYPE=t};var degree=Math.PI/180;glMatrix.toRadian=function(t){return t*degree};glMatrix.equals=function(t,e){return Math.abs(t-e)<=glMatrix.EPSILON*Math.max(1,Math.abs(t),Math.abs(e))};var mat2d={};mat2d.create=function(){var t=new glMatrix.ARRAY_TYPE(6);t[0]=1;t[1]=0;t[2]=0;t[3]=1;t[4]=0;t[5]=0;return t};mat2d.clone=function(t){var e=new glMatrix.ARRAY_TYPE(6);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];return e};mat2d.copy=function(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];return t};mat2d.identity=function(t){t[0]=1;t[1]=0;t[2]=0;t[3]=1;t[4]=0;t[5]=0;return t};mat2d.set=function(t,e,r,a,i,n,s){t[0]=e;t[1]=r;t[2]=a;t[3]=i;t[4]=n;t[5]=s;return t};mat2d.multiply=function(t,e,r){var a=e[0],i=e[1],n=e[2],s=e[3],o=e[4],h=e[5],l=r[0],u=r[1],f=r[2],c=r[3],g=r[4],v=r[5];t[0]=a*l+n*u;t[1]=i*l+s*u;t[2]=a*f+n*c;t[3]=i*f+s*c;t[4]=a*g+n*v+o;t[5]=i*g+s*v+h;return t};mat2d.mult=function(t,e,r,a,i,n,s,o){var h=e[0],l=e[1],u=e[2],f=e[3],c=e[4],g=e[5];t[0]=h*r+u*a;t[1]=l*r+f*a;t[2]=h*i+u*n;t[3]=l*i+f*n;t[4]=h*s+u*o+c;t[5]=l*s+f*o+g;return t};mat2d.rotate=function(t,e){var r=t[0],a=t[1],i=t[2],n=t[3],s=mat2d.sin(e),o=mat2d.cos(e);t[0]=r*o+i*s;t[1]=a*o+n*s;t[2]=r*-s+i*o;t[3]=a*-s+n*o};mat2d.scale=function(t,e,r){t[0]*=e;t[1]*=e;t[2]*=r;t[3]*=r};mat2d.translate=function(t,e,r){var a=t[0],i=t[1],n=t[2],s=t[3],o=t[4],h=t[5];t[4]=a*e+n*r+o;t[5]=i*e+s*r+h};mat2d.points=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];mat2d.transformPoint=function(t,e,r,a){var i=mat2d.points[a||0];i.x=t[0]*e+t[2]*r+t[4];i.y=t[1]*e+t[3]*r+t[5];return i};mat2d.transformPointInt=function(t,e,r,a){var i=mat2d.points[a||0];i.x=(t[0]*e+t[2]*r+t[4])*10>>0;i.y=(t[1]*e+t[3]*r+t[5])*10>>0;return i};mat2d.transformPoints=function(t,e){for(var r=0;r<e.length;r+=2){var a=e[r];var i=e[r+1];e[r]=t[0]*a+t[2]*i+t[4];e[r+1]=t[1]*a+t[3]*i+t[5]}return e};mat2d.sin=Math.sinFast;mat2d.cos=Math.cosFast;function WebGLProgram(){}WebGLProgram.activeProgram=null;WebGLProgram.prototype.create=function(t,e,r,a){this.gl=t;this.buffer=e;var i=t.createProgram();var n=this.createShader(t.FRAGMENT_SHADER,r);var s=this.createShader(t.VERTEX_SHADER,a);t.attachShader(i,s);t.attachShader(i,n);t.linkProgram(i);var o=t.getProgramParameter(i,t.LINK_STATUS);if(!o){alert("Could not initialise shaders:"+t.getProgramInfoLog(i))}this.program=i;this.init();return this};WebGLProgram.prototype.init=function(){};WebGLProgram.prototype.createShader=function(t,e){var r=this.gl;var a=r.createShader(t);r.shaderSource(a,e);r.compileShader(a);if(!r.getShaderParameter(a,r.COMPILE_STATUS)){alert(r.getShaderInfoLog(a));return null}return a};WebGLProgram.prototype.use=function(){if(WebGLProgram.activeProgram!==this.program){this.gl.useProgram(this.program);WebGLProgram.activeProgram=this.program}};WebGLProgram.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.gl.program=null};WebGLProgram.prototype.createDataBuffer=function(t){return Int16DataBuffer.create(t)};WebGLProgram.prototype.getDataBufferElementSize=function(){return 2};WebGLProgram.prototype.getDataBufferElementType=function(){return this.gl.SHORT};function WebGLProgramDrawImage(t,e,r,a){var i=this.fs.replace(/custom-shader/,a);this.name=t;this.create(e,r,i,this.vs);WebGLProgramDrawImage.programs[t]=this}WebGLProgramDrawImage.prototype=new WebGLProgram;WebGLProgramDrawImage.prototype.fs=["precision mediump float;","varying vec4 color;","varying vec2 vTextureCoord;","uniform vec4 size;","uniform sampler2D texture;","void main(void) {","custom-shader","}"].join("\n");WebGLProgramDrawImage.prototype.vs=["precision mediump float;","attribute vec4 aTextureCoord;","attribute vec2 aVertexPosition;","uniform vec4 size;","varying vec4 color;","varying vec2 vTextureCoord;","void main(void) {","    vec2 viewSize = size.xy;","    vec2 textureSize = size.zw;","    vec2 pos = (vec2(aVertexPosition.x/10.0, viewSize.y-aVertexPosition.y/10.0)/ viewSize) * 2.0 - 1.0;","    gl_Position = vec4(pos, 0, 1.0);","    vec2 v = vec2(aTextureCoord.x, aTextureCoord.y)/textureSize;","    vTextureCoord = vec2(v.s, 1.0-v.t);","    float alpha = aTextureCoord.z/256.0;","    float tint = aTextureCoord.w/256.0;","    color = vec4(tint, tint, tint, alpha);","}"].join("\n");WebGLProgramDrawImage.prototype.init=function(){var t=this.gl;var e=this.program;e.aTextureCoord=t.getAttribLocation(e,"aTextureCoord");e.aVertexPosition=t.getAttribLocation(e,"aVertexPosition");e.size=t.getUniformLocation(e,"size");e.samplerUniform=t.getUniformLocation(e,"texture");return};WebGLProgramDrawImage.prototype.addTriangle=function(t,e,r,a,i,n,s,o,h,l,u,f,c,g,v){var d=(l-n)*(v-u)-(u-s)*(g-l)>=0;if(d){return t.pushX(a,i,e,r,n,s,o,h,e,r,l,u,f,c,e,r,g,v)}else{return t.pushX(a,i,e,r,n,s,f,c,e,r,g,v,o,h,e,r,l,u)}};WebGLProgramDrawImage.prototype.draw=function(t,e){this.use();var r=this.gl;var a=this.program;var i=this.getDataBufferElementType();var n=this.getDataBufferElementSize();var s=n*6;var o=t.texture;if(o.dirty){o.update()}var h=e;var l=h.size/6;r.bindBuffer(r.ARRAY_BUFFER,this.buffer);r.bufferData(r.ARRAY_BUFFER,h,r.DYNAMIC_DRAW);r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_2D,o);r.vertexAttribPointer(a.aTextureCoord,4,i,false,s,0);r.enableVertexAttribArray(a.aTextureCoord);r.vertexAttribPointer(a.aVertexPosition,2,i,false,s,n*4);r.enableVertexAttribArray(a.aVertexPosition);r.uniform4f(a.size,r.w,r.h,o.w,o.h);r.drawArrays(r.TRIANGLES,0,l)};WebGLProgramDrawImage.defaultCustomFs=["  vec4 c = texture2D(texture, vTextureCoord) * color;","  if(c.a > 0.01) {","     gl_FragColor = c;","  }else{","     discard;","  }",""].join("\n");WebGLProgramDrawImage.create=function(t,e){var r=new WebGLProgramDrawImage("normal",t,e,WebGLProgramDrawImage.defaultCustomFs);return r};WebGLProgramDrawImage.grayCustomFs=["    vec4 c = texture2D(texture, vTextureCoord);","    float gray = c.r*0.3 + c.g*0.59 + c.b*0.11;","    gl_FragColor = vec4(gray, gray, gray, c.a) * color;"].join("\n");WebGLProgramDrawImage.createGray=function(t,e){var r=new WebGLProgramDrawImage("gray",t,e,WebGLProgramDrawImage.grayCustomFs);return r};WebGLProgramDrawImage.programs={};WebGLProgramDrawImage.init=function(t,e){WebGLProgramDrawImage.create(t,e);WebGLProgramDrawImage.createGray(t,e)};WebGLProgramDrawImage.get=function(t){return WebGLProgramDrawImage.programs[t]||WebGLProgramDrawImage.programs.normal};function WebGLProgramDrawPrimitives(t,e){this.create(t,e,this.fs,this.vs)}WebGLProgramDrawPrimitives.prototype=new WebGLProgram;WebGLProgramDrawPrimitives.prototype.fs=["precision mediump float;","varying vec4 vColor;","void main(void) {","    gl_FragColor = vColor;","}"].join("\n");WebGLProgramDrawPrimitives.prototype.vs=["precision mediump float;","attribute vec2 aVertexPosition;","uniform vec4 aSizeAlphaTint;","uniform vec4 aColor;","varying vec4 vColor;","void main(void) {","   vec2 size = vec2(aSizeAlphaTint.x, aSizeAlphaTint.y);","   float tint = aSizeAlphaTint.z/256.0;","	float alpha = aSizeAlphaTint.w/256.0;","   vec3 pos = vec3(aVertexPosition.x/10.0, aVertexPosition.y/10.0, 1.0);","   vec2 pos2 = (vec2(pos.x, size.y-pos.y)/size) * 2.0 - 1.0;","   gl_Position = vec4(pos2, 0, 1.0);","	vColor = aColor * vec4(tint, tint, tint, alpha);","}"].join("\n");WebGLProgramDrawPrimitives.prototype.init=function(){var t=this.gl;var e=this.program;e.aVertexPosition=t.getAttribLocation(e,"aVertexPosition");e.aColor=t.getUniformLocation(e,"aColor");e.aSizeAlphaTint=t.getUniformLocation(e,"aSizeAlphaTint");return};WebGLProgramDrawPrimitives.prototype.clip=function(t,e){this.draw(this.gl.TRIANGLE_FAN,t,e)};WebGLProgramDrawPrimitives.prototype.stroke=function(t,e){this.draw(this.gl.LINE_STRIP,t,e)};WebGLProgramDrawPrimitives.prototype.fill=function(t,e){this.draw(this.gl.TRIANGLE_FAN,t,e)};WebGLProgramDrawPrimitives.prototype.prepareDraw=function(t,e,r,a){this.use();var i=this.gl;var n=this.program;var s=this.getDataBufferElementType();var o=this.getDataBufferElementSize();i.bindBuffer(i.ARRAY_BUFFER,this.buffer);i.bufferData(i.ARRAY_BUFFER,t,i.DYNAMIC_DRAW);i.vertexAttribPointer(n.aVertexPosition,2,s,false,0,0);i.enableVertexAttribArray(n.aVertexPosition);i.uniform4f(n.aColor,e.r,e.g,e.b,e.a);i.uniform4f(n.aSizeAlphaTint,i.w,i.h,a,r)};WebGLProgramDrawPrimitives.prototype.draw=function(t,e,r){var a=this.gl;var i=e>>1;var n=r-e>>1;a.drawArrays(t,i,n)};WebGLProgramDrawPrimitives.prototype.createDataBuffer=function(t){return Int16DataBuffer.create(t)};WebGLProgramDrawPrimitives.prototype.getDataBufferElementSize=function(){return 2};WebGLProgramDrawPrimitives.prototype.getDataBufferElementType=function(){return this.gl.SHORT};Int16Array.prototype.push=function(){var t=arguments;var e=this.size;var r=this.length;var a=t.length;for(var i=0;i<a&&e<r;i++){this[e++]=t[i]}this.size=e;return this};Int16Array.prototype.extend=function(){var t=this.size;var e=this.length+1024;var r=Int16Array.create(e);r.size=t;for(var a=0;a<t;a++){r[a]=this[a]}return r};Float32Array.prototype.extend=function(){var t=this.size;var e=this.length+1024;var r=Float32Array.create(e);r.size=t;for(var a=0;a<t;a++){r[a]=this[a]}return r};Int16Array.prototype.pushX=function(){var t=this;var e=arguments;var r=e.length;if(this.size+1024+r>this.length){t=this.extend()}var a=this.size;for(var i=0;i<r;i++,a++){t[a]=e[i]}t.size+=r;return t};Int16Array.prototype.push1=function(t){var e=this;if(this.size+10>=this.length){e=this.extend()}e[this.size++]=t;return e};Float32Array.prototype.push1=function(t){var e=this;if(this.size+10>=this.length){e=this.extend()}e[this.size++]=t;return e};Int16Array.prototype.push2=function(t,e){var r=this;if(this.size+10>=this.length){r=this.extend()}r[this.size++]=t;r[this.size++]=e;return r};Float32Array.prototype.push2=function(t,e){var r=this;if(this.size+10>=this.length){r=this.extend()}r[this.size++]=t;r[this.size++]=e;return r};Float32Array.prototype.pushX=function(){var t=this;var e=arguments;var r=e.length;if(this.size+1024+r>this.length){t=this.extend()}var a=this.size;for(var i=0;i<r;i++,a++){t[a]=e[i]}t.size+=r;return t};Float32Array.prototype.pushArr=Int16Array.prototype.pushArr=function(t){var e=this;var r=t.length;if(this.size+1024+r>this.length){e=this.extend()}var a=this.size;for(var i=0;i<r;i++,a++){e[a]=t[i]}e.size+=r;return e};Float32Array.prototype.reset=Int16Array.prototype.reset=function(){this.size=0;return this};Int16Array.create=function(t){var e=new Int16Array(t);e.size=0;return e};Float32Array.create=function(t){var e=new Float32Array(t);e.size=0;return e};Int16Array.prototype.dup=function(){var t=this.size;var e=Int16Array.create(t);for(var r=0;r<t;r++){e[r]=this[r]}e.size=t;return e};Float32Array.prototype.dup=function(){var t=this.size;var e=Float32Array.create(t);for(var r=0;r<t;r++){e[r]=this[r]}e.size=t;return e};Float32Array.prototype.slice=Int16Array.prototype.slice=Array.prototype.slice;(function(){function t(t,e,r,a){this.x=t||0;this.y=e||0;this.width=r||0;this.height=a||0}t.prototype={constructor:t,clone:function(){return new t(this.x,this.y,this.width,this.height)}};t.isContainedIn=function(t,e){return t.x>=e.x&&t.y>=e.y&&t.x+t.width<=e.x+e.width&&t.y+t.height<=e.y+e.height};var e=0;var r=1;var a=2;var i=3;var n=4;function s(t,e,r){this.binWidth=0;this.binHeight=0;this.allowRotate=false;this.usedRectangles=[];this.freeRectangles=[];this.init(t,e,r)}s.prototype={constructor:s,init:function(e,r,a){this.binWidth=e;this.binHeight=r;this.allowRotate=a||false;this.usedRectangles.length=0;this.freeRectangles.length=0;this.freeRectangles.push(new t(0,0,e,r))},insert:function(s,o,h){var l=new t;var u={value:0};var f={value:0};h=h||0;switch(h){case e:l=this._findPositionForNewNodeBestShortSideFit(s,o,u,f);break;case i:l=this._findPositionForNewNodeBottomLeft(s,o,u,f);break;case n:l=this._findPositionForNewNodeContactPoint(s,o,u);break;case r:l=this._findPositionForNewNodeBestLongSideFit(s,o,f,u);break;case a:l=this._findPositionForNewNodeBestAreaFit(s,o,u,f);break}if(l.height===0){return l}this._placeRectangle(l);return l},insert2:function(e,r){var a=[];while(e.length>0){var i=Infinity;var n=Infinity;var s=-1;var o=new t;for(var h=0;h<e.length;h++){var l={value:0};var u={value:0};var f=this._scoreRectangle(e[h].width,e[h].height,r,l,u);if(l.value<i||l.value==i&&u.value<n){i=l.value;n=u.value;o=f;s=h}}if(s==-1){return a}this._placeRectangle(o);var c=e.splice(s,1)[0];c.x=o.x;c.y=o.y;a.push(c)}return a},_placeRectangle:function(t){var e=this.freeRectangles.length;for(var r=0;r<e;r++){if(this._splitFreeNode(this.freeRectangles[r],t)){this.freeRectangles.splice(r,1);r--;e--}}this._pruneFreeList();this.usedRectangles.push(t)},_scoreRectangle:function(s,o,h,l,u){var f=new t;l.value=Infinity;u.value=Infinity;switch(h){case e:f=this._findPositionForNewNodeBestShortSideFit(s,o,l,u);break;case i:f=this._findPositionForNewNodeBottomLeft(s,o,l,u);break;case n:f=this._findPositionForNewNodeContactPoint(s,o,l);l=-l;break;case r:f=this._findPositionForNewNodeBestLongSideFit(s,o,u,l);break;case a:f=this._findPositionForNewNodeBestAreaFit(s,o,l,u);break}if(f.height===0){l.value=Infinity;u.value=Infinity}return f},_occupancy:function(){var t=this.usedRectangles;var e=0;for(var r=0;r<t.length;r++){e+=t[r].width*t[r].height}return e/(this.binWidth*this.binHeight)},_findPositionForNewNodeBottomLeft:function(e,r,a,i){var n=this.freeRectangles;var s=new t;a.value=Infinity;var o;var h;for(var l=0;l<n.length;l++){o=n[l];if(o.width>=e&&o.height>=r){h=o.y+r;if(h<a.value||h==a.value&&o.x<i.value){s.x=o.x;s.y=o.y;s.width=e;s.height=r;a.value=h;i.value=o.x}}if(this.allowRotate&&o.width>=r&&o.height>=e){h=o.y+e;if(h<a.value||h==a.value&&o.x<i.value){s.x=o.x;s.y=o.y;s.width=r;s.height=e;a.value=h;i.value=o.x}}}return s},_findPositionForNewNodeBestShortSideFit:function(e,r,a,i){var n=this.freeRectangles;var s=new t;a.value=Infinity;var o;var h;var l;var u;var f;for(var c=0;c<n.length;c++){o=n[c];if(o.width>=e&&o.height>=r){h=Math.abs(o.width-e);l=Math.abs(o.height-r);u=Math.min(h,l);f=Math.max(h,l);if(u<a.value||u==a.value&&f<i.value){s.x=o.x;s.y=o.y;s.width=e;s.height=r;a.value=u;i.value=f}}var g;var v;var d;var p;if(this.allowRotate&&o.width>=r&&o.height>=e){g=Math.abs(o.width-r);v=Math.abs(o.height-e);d=Math.min(g,v);p=Math.max(g,v);if(d<a.value||d==a.value&&p<i.value){s.x=o.x;s.y=o.y;s.width=r;s.height=e;a.value=d;i.value=p}}}return s},_findPositionForNewNodeBestLongSideFit:function(e,r,a,i){var n=this.freeRectangles;var s=new t;i.value=Infinity;var o;var h;var l;var u;var f;for(var c=0;c<n.length;c++){o=n[c];if(o.width>=e&&o.height>=r){h=Math.abs(o.width-e);l=Math.abs(o.height-r);u=Math.min(h,l);f=Math.max(h,l);if(f<i.value||f==i.value&&u<a.value){s.x=o.x;s.y=o.y;s.width=e;s.height=r;a.value=u;i.value=f}}if(this.allowRotate&&o.width>=r&&o.height>=e){h=Math.abs(o.width-r);l=Math.abs(o.height-e);u=Math.min(h,l);f=Math.max(h,l);if(f<i.value||f==i.value&&u<a.value){s.x=o.x;s.y=o.y;s.width=r;s.height=e;a.value=u;i.value=f}}}return s},_findPositionForNewNodeBestAreaFit:function(e,r,a,i){var n=this.freeRectangles;var s=new t;a.value=Infinity;var o;var h;var l;var u;var f;for(var c=0;c<n.length;c++){o=n[c];f=o.width*o.height-e*r;if(o.width>=e&&o.height>=r){h=Math.abs(o.width-e);l=Math.abs(o.height-r);u=Math.min(h,l);if(f<a.value||f==a.value&&u<i.value){s.x=o.x;s.y=o.y;s.width=e;s.height=r;i.value=u;a=f}}if(this.allowRotate&&o.width>=r&&o.height>=e){h=Math.abs(o.width-r);l=Math.abs(o.height-e);u=Math.min(h,l);if(f<a.value||f==a.value&&u<i.value){s.x=o.x;s.y=o.y;s.width=r;s.height=e;i.value=u;a.value=f}}}return s},_commonIntervalLength:function(t,e,r,a){if(e<r||a<t){return 0}return Math.min(e,a)-Math.max(t,r)},_contactPointScoreNode:function(t,e,r,a){var i=this.usedRectangles;var n=0;if(t==0||t+r===this.binWidth)n+=a;if(e==0||e+a===this.binHeight)n+=r;var s;for(var o=0;o<i.length;o++){s=i[o];if(s.x==t+r||s.x+s.width==t)n+=this._commonIntervalLength(s.y,s.y+s.height,e,e+a);if(s.y==e+a||s.y+s.height==e)n+=this._commonIntervalLength(s.x,s.x+s.width,t,t+r)}return n},_findPositionForNewNodeContactPoint:function(e,r,a){var i=this.freeRectangles;var n=new t;a.value=-1;var s;var o;for(var h=0;h<i.length;h++){s=i[h];if(s.width>=e&&s.height>=r){o=this._contactPointScoreNode(s.x,s.y,e,r);if(o>a.value){n.x=s.x;n.y=s.y;n.width=e;n.height=r;a=o}}if(this.allowRotate&&s.width>=r&&s.height>=e){o=this._contactPointScoreNode(s.x,s.y,r,e);if(o>a.value){n.x=s.x;n.y=s.y;n.width=r;n.height=e;a.value=o}}}return n},_splitFreeNode:function(t,e){var r=this.freeRectangles;if(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y)return false;var a;if(e.x<t.x+t.width&&e.x+e.width>t.x){if(e.y>t.y&&e.y<t.y+t.height){a=t.clone();a.height=e.y-a.y;r.push(a)}if(e.y+e.height<t.y+t.height){a=t.clone();a.y=e.y+e.height;a.height=t.y+t.height-(e.y+e.height);r.push(a)}}if(e.y<t.y+t.height&&e.y+e.height>t.y){if(e.x>t.x&&e.x<t.x+t.width){a=t.clone();a.width=e.x-a.x;r.push(a)}if(e.x+e.width<t.x+t.width){a=t.clone();a.x=e.x+e.width;a.width=t.x+t.width-(e.x+e.width);r.push(a)}}return true},_pruneFreeList:function(){var e=this.freeRectangles;for(var r=0;r<e.length;r++)for(var a=r+1;a<e.length;a++){if(t.isContainedIn(e[r],e[a])){e.splice(r,1);break}if(t.isContainedIn(e[a],e[r])){e.splice(a,1)}}}};window.MaxRectsBinPack=s})();Math.normalize=function(t,e,r){var a=Math.sqrt(t*t+e*e);if(a>1e-6){var i=1/a;r.x=t*i;r.y=e*i}r.d=a;return r};Math.cross=function(t,e,r,a){return r*e-t*a};Math.ptEquals=function(t,e,r,a,i){var n=r-t;var s=a-e;return n*n+s*s<i*i};Math.distPtSeg=function(t,e,r,a,i,n){var s,o,h,l,u,f;s=i-r;o=n-a;h=t-r;l=e-a;u=s*s+o*o;f=s*h+o*l;if(u>0)f/=u;if(f<0)f=0;else if(f>1)f=1;h=r+f*s-t;l=a+f*o-e;return h*h+l*l};function parseFontSize(t){var e=12;var r=t.match(/\d+pt|\d+px/g);if(r){var a=r[0];e=parseInt(a);if(a.indexOf("pt")>0){e=Math.round(e*1.2)}}return e}function AutoPacker(){}AutoPacker.prototype.init=function(t){this.gl=t;this.w=512;this.h=1024;this.imageMaxWidth=256;this.imageMaxHeight=256;this.canvas=document.createElement("canvas");this.canvas.cannotPack=true;this.glyphCache={};this.imagesCache=[];this.createTexture();this.setOverflow(false);return this.reset()};AutoPacker.prototype.resetImagesCache=function(){var t=this.imagesCache;var e=t.length;for(var r=0;r<e;r++){var a=t[r];a.ox=0;a.oy=0;a.packed=false;a.texture=null}t.length=0};AutoPacker.prototype.extendCanvas=function(){if(this.isOverflow()){if(this.w<2048||this.h<2048){if(this.w<this.h){this.w=this.w<<1}else{this.h=this.h<<1}}else{if(this.imageMaxWidth>this.imageMaxHeight){this.imageMaxWidth=this.imageMaxWidth<<1}else{this.imageMaxHeight=this.imageMaxHeight<<1}}this.setOverflow(false);console.log("extend canvas to "+this.w+"x"+this.h)}this.canvas.width=this.w;this.canvas.height=this.h;this.ctx=this.canvas.getContext("2d")};AutoPacker.prototype.reset=function(){this.resetImagesCache();this.glyphCache={};this.extendCanvas();var t=this.ctx;t.textAlign="left";t.textBaseline="middle";t.clearRect(0,0,this.w,this.h);this.binPacker=new MaxRectsBinPack(this.w,this.h,false);return this};AutoPacker.prototype.getAvailableRect=function(t,e){var r=this.binPacker.insert(t,e,0);if(r){r.w=t;r.h=e}return r};AutoPacker.prototype.addGlyph=function(t,e,r,a){var i=this.ctx;if(i.font!==t){i.font=t}if(i.fillStyle!==r){i.fillStyle=r}var n=Math.ceil(i.measureText(a).width);var s=Math.ceil(e*1.3);var o=n>>2;var h=e>>2;var l=this.getAvailableRect(n+o*2,s+h*2);if(l){l.x+=o;l.y+=h;l.w=n;l.h=s;if(t.indexOf("italic")>=0){l.charW=l.w+o}else{l.charW=l.w}var u=AutoPacker.toGlyphKey(t,a,r);i.fillText(a,l.x,l.y+(l.h>>1));this.glyphCache[u]=l;this.setDirty(true)}return l};AutoPacker.prototype.measureText=function(t,e,r,a){var i=0;var n=e.length;var s=parseFontSize(t);for(var o=0;o<n;o++){var h=e[o];var l=this.getGlyph(t,h,r);if(!l){l=this.addGlyph(t,s,r,h)}if(l){i+=l.w}}a.w=i;a.h=s;return a};AutoPacker.toGlyphKey=function(t,e,r){return t+e+r};AutoPacker.prototype.hasGlyph=function(t,e,r){return!!this.glyphCache[AutoPacker.toGlyphKey(t,e,r)]};AutoPacker.prototype.setOverflow=function(t){this.overflow=t};AutoPacker.prototype.isOverflow=function(t){return this.overflow};AutoPacker.prototype.getGlyph=function(t,e,r){return this.glyphCache[AutoPacker.toGlyphKey(t,e,r)]};AutoPacker.prototype.packImage=function(t){if(!t.src||t.src.indexOf("data:")===0||t.width>this.imageMaxWidth||t.height>this.imageMaxHeight){t.ox=0;t.oy=0;t.cannotPack=true;return}var e=this.getAvailableRect(t.width+4,t.height+4);if(e.height<t.height){t.ox=0;t.oy=0;this.setOverflow(true);return}var r=e.x+2;var a=e.y+2;var i=this.canvas.texture;this.setDirty(true);this.ctx.drawImage(t,r,a);t.ox=r;t.oy=a;t.packed=true;if(t.texture&&t.texture!==i){this.gl.deleteTexture(t.texture);
}t.texture=this.canvas.texture;this.imagesCache.push(t);return};AutoPacker.prototype.setDirty=function(t){this.canvas.texture.setDirty(t)};AutoPacker.prototype.createTexture=function(){var t=this.gl;var e=t.createTexture();e.src=null;e.image=this.canvas;this.canvas.texture=e;e.dirty=true;e.setDirty=function(t){this.dirty=t};e.update=function(){if(!this.dirty)return;var e=this.image;this.dirty=false;this.w=e.width;this.h=e.height;t.bindTexture(t.TEXTURE_2D,this);t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,true);t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.bindTexture(t.TEXTURE_2D,null)}};AutoPacker.prototype.getImage=function(){return this.canvas};function CanvasRenderingContext2DWebGL(t){this.distTol=.01;this.tessTol=.0025;this.currentID=1e3;this.fps=0;this.lastX=0;this.lastY=0;this.firstX=0;this.firstY=0;this.showFPS=false;this.renderTimes=0;this.startTime=Date.now();this.lastSeconds=this.startTime/1e3>>0;this.drawCalls=0;this.drawImageCalls=0;this.drawImageCount=0;this.fillCount=0;this.strokeCount=0;this.clipLevel=0;this.canvasWidth=0;this.canvasHeight=0;this.canvasWidth10=0;this.canvasHeight10=0;this.zeroPoint={x:0,y:0};this.tempRect={x:0,y:0,w:0,h:0};this.webglOptions=t||CanvasRenderingContext2DWebGL.webglOptions}CanvasRenderingContext2DWebGL.webglOptions={antialias:false,stencil:true,preserveDrawingBuffer:true,premultipliedAlpha:false};CanvasRenderingContext2DWebGL.prototype.save=function(){this.stack.push(this.state.clone())};CanvasRenderingContext2DWebGL.prototype.restore=function(){var t=this.state;var e=this.stack.pop();if(e){if(e.clipRect||t.clipRect){if(!e.clipRect||!t.clipRect||e.clipRect!==t.clipRect){this.doClipRect(e.clipRect)}}if(e.clipPaths||t.clipPaths){if(!e.clipPaths||!t.clipPaths||e.clipPaths.id!==t.clipPaths.id){this.clearClip(t.clipPaths)}}this.state=e;if(t.globalCompositeOperation!==e.globalCompositeOperation){this.globalCompositeOperationApply(e.globalCompositeOperation)}}else{console.log("restore times > save times.")}CanvasRenderingContext2DWebGL.destroyState(t)};CanvasRenderingContext2DWebGL.prototype.scale=function(t,e){mat2d.scale(this.state.m,t,e)};CanvasRenderingContext2DWebGL.prototype.rotate=function(t){mat2d.rotate(this.state.m,t)};CanvasRenderingContext2DWebGL.prototype.translate=function(t,e){mat2d.translate(this.state.m,t,e)};CanvasRenderingContext2DWebGL.prototype.transform=function(t,e,r,a,i,n){var s=this.state.m;mat2d.mult(s,s,t,e,r,a,i,n)};CanvasRenderingContext2DWebGL.prototype.setTransform=function(t,e,r,a,i,n){mat2d.set(this.state.m,t,e,r,a,i,n)};CanvasRenderingContext2DWebGL.prototype.scaleArr=function(t,e,r){mat2d.scale(this.state.m,t[e],t[r])};CanvasRenderingContext2DWebGL.prototype.rotateArr=function(t,e){mat2d.rotate(this.state.m,t[e])};CanvasRenderingContext2DWebGL.prototype.translateArr=function(t,e,r){mat2d.translate(this.state.m,t[e],t[r])};CanvasRenderingContext2DWebGL.prototype.transformMatrix=function(t){var e=this.state.m;mat2d.multiply(e,e,t)};CanvasRenderingContext2DWebGL.prototype.setTransformMatrix=function(t){mat2d.copy(this.state.m,t)};Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"globalTint",{get:function(){return this.state.globalTint},set:function(t){this.state.globalTint=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"globalImageFilter",{get:function(){return this.state.globalImageFilter},set:function(t){this.state.globalImageFilter=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"globalAlpha",{get:function(){return this.state.globalAlpha},set:function(t){this.state.globalAlpha=t},enumerable:false,configurable:true});CanvasRenderingContext2DWebGL.prototype.globalCompositeOperationApply=function(t){var e=this.gl;this.commitDrawImage();if("darker"==t){e.blendEquation(e.FUNC_SUBTRACT)}else{e.blendEquation(e.FUNC_ADD)}switch(t){case"source-over":e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case"destination-over":e.blendFunc(e.ONE_MINUS_DST_ALPHA,e.ONE);break;case"clear":e.blendFunc(e.ZERO,e.ZERO);break;case"copy":case"source":e.blendFunc(e.ONE,e.ZERO);break;case"destination":e.blendFunc(e.ZERO,e.ONE);break;case"source-atop":e.blendFunc(e.DST_ALPHA,e.ONE_MINUS_SRC_ALPHA);break;case"destination-atop":e.blendFunc(e.ONE_MINUS_DST_ALPHA,e.SRC_ALPHA);break;case"source-in":e.blendFunc(e.DST_ALPHA,e.ZERO);break;case"destination-in":e.blendFunc(e.ZERO,e.SRC_ALPHA);break;case"source-out":e.blendFunc(e.ONE_MINUS_DST_ALPHA,e.ZERO);break;case"destination-out":e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_ALPHA);break;case"lighter":case"darker":e.blendFunc(e.ONE,e.ONE);break;case"xor":e.blendFunc(e.ONE_MINUS_DST_ALPHA,e.ONE_MINUS_SRC_ALPHA);break;case"normal":default:e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);break}};Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"globalCompositeOperation",{get:function(){return this.state.globalCompositeOperation},set:function(t){if(t!==this.state.globalCompositeOperation){this.state.globalCompositeOperation=t;this.globalCompositeOperationApply(t)}},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"strokeStyle",{get:function(){return this.state.strokeStyle.str},set:function(t){var e=this.state.strokeStyle.str;if(t&&e!==t){this.state.strokeStyle=CanvasRenderingContext2DWebGL.parseColor(t)}},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"fillStyle",{get:function(){return this.state.fillStyle.str},set:function(t){var e=this.state.fillStyle.str;if(t&&e!==t){this.state.fillStyle=CanvasRenderingContext2DWebGL.parseColor(t)}},enumerable:false,configurable:true});CanvasRenderingContext2DWebGL.prototype.clearRect=function(t,e,r,a){this.beginPath();this.rect(t,e,r,a);this.fill();this.beginPath()};CanvasRenderingContext2DWebGL.prototype.fillRect=function(t,e,r,a){this.beginPath();this.rect(t,e,r,a);this.fill();this.beginPath()};CanvasRenderingContext2DWebGL.prototype.strokeRect=function(t,e,r,a){this.beginPath();this.rect(t,e,r,a);this.stroke();this.beginPath()};CanvasRenderingContext2DWebGL.prototype.stroke=function(){if(this.lineWidth&&this.strokeStyle){this.gl.lineWidth(this.lineWidth);this.commitDrawImage();this.strokeCount++;var t=this.drawPrimitivesProgram;this.drawPrimitives(t,this.drawPrimitiveQueue,t.stroke,this.state.strokeStyle)}};CanvasRenderingContext2DWebGL.prototype.fill=function(){if(this.fillStyle){this.commitDrawImage();this.fillCount++;var t=this.drawPrimitivesProgram;this.drawPrimitives(t,this.drawPrimitiveQueue,t.fill,this.state.fillStyle)}};CanvasRenderingContext2DWebGL.prototype.drawStencil=function(t,e,r){var a=this.gl;var i=this.drawPrimitivesProgram;var n=r?a.DECR:a.INCR;a.stencilMask(255);a.stencilFunc(a.ALWAYS,1,255);a.stencilOp(a.KEEP,a.KEEP,n);a.colorMask(false,false,false,false);this.drawPrimitives(i,t,i.clip,this.stencilColor);a.stencilMask(0);a.stencilFunc(a.EQUAL,e,255);a.colorMask(true,true,true,true)};CanvasRenderingContext2DWebGL.prototype.clearClip=function(t){var e=this.gl;if(!t){e.disable(e.STENCIL_TEST);return}this.commitDrawImage();this.drawStencil(t,--this.clipLevel,true)};CanvasRenderingContext2DWebGL.prototype.clip=function(){this.savePrimitiveQueueForClip();var t=this.gl;if(this.clipLevel===0){t.enable(t.STENCIL_TEST)}this.commitDrawImage();var e=this.state.clipPaths;if(e){this.drawStencil(e,++this.clipLevel,false)}};CanvasRenderingContext2DWebGL.prototype.drawPrimitives=function(t,e,r,a){var i=e.dataBuffer.getReadBuffer();var n=e.paths;var s=this.state;var o=0;var h=0;var l=null;var u=n.size;var f=s.globalTint*256>>0;var c=s.globalAlpha*256>>0;t.prepareDraw(i,a,c,f);for(var g=0;g<u;g++){var h=n[g];if(g<u-1){o=n[g+1]}else{o=i.size}if(o>h){this.drawCalls++;r.call(t,h,o)}}};CanvasRenderingContext2DWebGL.prototype.doClipRect=function(t){var e=this.gl;var r=this.canvas;var a=r.width;var i=r.height;this.commitDrawImage();e.enable(e.SCISSOR_TEST);if(!t||!t.w||!t.h){e.scissor(0,0,a,i)}else{var n=e.w;var s=e.h;var o=a/n;var h=i/s;var l=(t.y-1)*h;var u=t.x*o;var f=t.w*o;var c=t.h*h;var g=i-(l+c);e.scissor(u,g,f,c)}};CanvasRenderingContext2DWebGL.prototype.clipRect=function(t,e,r,a){var i=this.state;var n=i.m;var s=mat2d.transformPoint(n,t,e);var o=i.clipRect;i.clipRect={x:s.x,y:s.y,w:r,h:a};if(o){i.clipRect=Rect.intersection(i.clipRect,o)}if(i.clipRect){this.doClipRect(i.clipRect)}};CanvasRenderingContext2DWebGL.prototype.drawGlyph=function(t,e,r,a,i,n,s,o,h,l){this.prepareDrawImage(t,e);this.drawImageEx(t,r,a,i,n,s*10,o*10,(s+h)*10,o*10,(s+h)*10,(o+l)*10,s*10,(o+l)*10)};CanvasRenderingContext2DWebGL.prototype.doFillText=function(t,e,r,a){var i=e;var n=r;var s=this.gl;var o=this.tempRect;var h=this.font||"16px sans";var l=this.autoPacker;var u=this.state.fillStyle;var f=u.str;if(!this.autoPacker.measureText(h,t,f,o)){console.log("invalid font size");return}var c=this.autoPacker.getImage();switch(this.textAlign){case"right":{i=e-o.w;break}case"center":{i=e-(o.w>>1);break}default:break}switch(this.textBaseline){case"bottom":{n=r-o.h;break}case"middle":{n=r-(o.h>>1);break}default:break}var g=t.length;var v=WebGLProgramDrawImage.get("normal");for(var d=0;d<g;d++){var p=t[d];var m=l.getGlyph(h,p,f);if(m){this.drawGlyph(c,v,m.x,m.y,m.charW,m.h,i,n,m.charW,m.h);i+=m.w}}return};CanvasRenderingContext2DWebGL.prototype.fillText=function(t,e,r,a){var i=this.state.m;var n=mat2d.transformPointInt(i,e,r);this.doFillText(t,n.x/10,n.y/10,a)};CanvasRenderingContext2DWebGL.prototype.strokeText=function(){console.log("strokeText NOT IMPL")};CanvasRenderingContext2DWebGL.prototype.drawImageTriArr=function(t,e){var r=0;var a=e.length/12>>0;for(var i=0;i<a;i++){this.drawImageTri(t,e[r++],e[r++],e[r++],e[r++],e[r++],e[r++],e[r++],e[r++],e[r++],e[r++],e[r++],e[r++])}};CanvasRenderingContext2DWebGL.prototype.drawImageTri=function(t,e,r,a,i,n,s,o,h,l,u,f,c){var g=this.state.m;var v=mat2d.transformPointInt(g,a,i,0);var d=mat2d.transformPointInt(g,o,h,1);var p=mat2d.transformPointInt(g,f,c,2);var m=(d.x-v.x)*(p.y-d.y)-(d.y-v.y)*(p.x-d.x)>=0;if(m){this.doDrawImageTri(t,e,r,v.x,v.y,n,s,d.x,d.y,l,u,p.x,p.y)}else{this.doDrawImageTri(t,e,r,v.x,v.y,l,u,p.x,p.y,n,s,d.x,d.y)}};CanvasRenderingContext2DWebGL.prototype.doDrawImageTri=function(t,e,r,a,i,n,s,o,h,l,u,f,c){this.drawImageCount++;if(t.complete){var g=t.ox;var v=t.oy;var d=this.state;var p=this.drawImageQueue;var m=WebGLProgramDrawImage.get(d.globalImageFilter);this.prepareDrawImage(t,m);p.dataBuffer=m.addTriangle(p.dataBuffer,d.globalAlpha*256>>0,d.globalTint*256>>0,e+g,r+v,a,i,n+g,s+v,o,h,l+g,u+v,f,c)}};CanvasRenderingContext2DWebGL.prototype.drawImage=function(t,e,r,a,i,n,s,o,h){var l,u,f,c,g,v,d,p;if(!t.width){return}if(h){l=e;u=r;f=a;c=i;g=n;v=s;d=o;p=h}else if(a){l=0;u=0;f=t.width;c=t.height;g=e;v=r;d=a;p=i}else{l=0;u=0;f=t.width;c=t.height;g=e;v=r;d=f;p=c}var m=this.state;var y=WebGLProgramDrawImage.get(m.globalImageFilter);this.prepareDrawImage(t,y);var b=m.m;var x=b[0];var C=b[1];var w=b[2];var P=b[3];var R=b[4];var D=b[5];var L=v;var I=g;var A=g+d;var W=v+p;var T=(x*I+w*L+R)*10>>0;var G=(C*I+P*L+D)*10>>0;var E=(x*A+w*L+R)*10>>0;var S=(C*A+P*L+D)*10>>0;var M=(x*A+w*W+R)*10>>0;var B=(C*A+P*W+D)*10>>0;var k=(x*I+w*W+R)*10>>0;var _=(C*I+P*W+D)*10>>0;var F=this.canvasWidth10;var z=this.canvasHeight10;if(T<0&&E<0&&M<0&&k<0||G<0&&S<0&&B<0&&_<0||T>F&&E>F&&M>F&&k>F||G>z&&S>z&&B>z&&_>z){this.drawImageCount++;return}this.drawImageEx(t,l+t.ox,u+t.oy,f,c,T,G,E,S,M,B,k,_)};CanvasRenderingContext2DWebGL.prototype.prepareDrawImage=function(t,e){var r=this.drawImageQueue;if(r.image){if(r.image.texture!==t.texture||r.program!==e||r.globalCompositeOperation!==this.state.globalCompositeOperation){this.commitDrawImage();r.image=t;r.program=e;if(!t.cannotPack&&!t.packed){this.autoPacker.packImage(t);this.loadTextureWithImage(t)}}}else{if(!t.cannotPack&&!t.packed){this.autoPacker.packImage(t);this.loadTextureWithImage(t)}r.image=t;r.program=e}};CanvasRenderingContext2DWebGL.prototype.drawImageEx=function(t,e,r,a,i,n,s,o,h,l,u,f,c){this.drawImageCount++;var g=this.drawImageQueue.dataBuffer;var v=g.getWriteBuffer(100);var d=g.size;var p=this.state.globalTint*256>>0;var m=this.state.globalAlpha*256>>0;v[d++]=e;v[d++]=r;v[d++]=m;v[d++]=p;v[d++]=n;v[d++]=s;v[d++]=e+a;v[d++]=r;v[d++]=m;v[d++]=p;v[d++]=o;v[d++]=h;v[d++]=e+a;v[d++]=r+i;v[d++]=m;v[d++]=p;v[d++]=l;v[d++]=u;v[d++]=e+a;v[d++]=r+i;v[d++]=m;v[d++]=p;v[d++]=l;v[d++]=u;v[d++]=e;v[d++]=r+i;v[d++]=m;v[d++]=p;v[d++]=f;v[d++]=c;v[d++]=e;v[d++]=r;v[d++]=m;v[d++]=p;v[d++]=n;v[d++]=s;g.size=d;return};CanvasRenderingContext2DWebGL.prototype.commitDrawImage=function(){var t=this.drawImageQueue;var e=t.dataBuffer.getReadBuffer();if(e.size<1||!t.image){return}this.drawImageBatch(t.image,t.program,e);t.dataBuffer.reset();t.image=null;t.program=null;t.globalCompositeOperation=this.globalCompositeOperation;return};Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"lineWidth",{get:function(){return this.state.lineWidth},set:function(t){this.state.lineWidth=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"lineCap",{get:function(){return this.state.lineCap},set:function(t){this.state.lineCap=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"lineJoin",{get:function(){return this.state.lineJoin},set:function(t){this.state.lineJoin=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"miterLimit",{get:function(){return this.state.miterLimit},set:function(t){this.state.miterLimit=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"font",{get:function(){return this.state.font},set:function(t){this.state.font=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"textAlign",{get:function(){return this.state.textAlign},set:function(t){this.state.textAlign=t},enumerable:false,configurable:true});Object.defineProperty(CanvasRenderingContext2DWebGL.prototype,"textBaseline",{get:function(){return this.state.textBaseline},set:function(t){this.state.textBaseline=t},enumerable:false,configurable:true});CanvasRenderingContext2DWebGL.prototype.beginPath=function(){this.drawPrimitiveQueue.dataBuffer.reset();this.drawPrimitiveQueue.paths.reset()};CanvasRenderingContext2DWebGL.prototype.closePath=function(){this.addPoint(this.firstX,this.firstY,false)};CanvasRenderingContext2DWebGL.prototype.savePrimitiveQueueForClip=function(){var t=this.drawPrimitiveQueue;if(t.dataBuffer.size<6){return}this.state.clipPaths={id:this.currentID++,paths:t.paths.dup(),dataBuffer:t.dataBuffer.dup()}};CanvasRenderingContext2DWebGL.prototype.hasPoint=function(){return this.drawPrimitiveQueue.dataBuffer.size>0};CanvasRenderingContext2DWebGL.prototype.addPoint=function(t,e,r){var a=this.drawPrimitiveQueue;var i=a.dataBuffer;if(r){this.firstX=t;this.firstY=e;a.paths.push1(i.size)}this.lastX=t;this.lastY=e;a.dataBuffer=i.pushX(t,e);return};CanvasRenderingContext2DWebGL.prototype.moveTo=function(t,e){var r=this.state.m;var a=mat2d.transformPointInt(r,t,e);this.addPoint(a.x,a.y,true)};CanvasRenderingContext2DWebGL.prototype.lineTo=function(t,e){var r=this.state.m;var a=mat2d.transformPointInt(r,t,e);this.addPoint(a.x,a.y,false)};CanvasRenderingContext2DWebGL.prototype.getWidth=function(){return this.canvas.w||this.canvas.width};CanvasRenderingContext2DWebGL.prototype.getHeight=function(){return this.canvas.h||this.canvas.height};CanvasRenderingContext2DWebGL.prototype.bigRect=function(t,e,r,a){var i=this.canvasWidth10;var n=this.canvasHeight10;var s=Math.polygonclip([[t.x,t.y],[e.x,e.y],[r.x,r.y],[a.x,a.y]],[-10,-10,i+20,n+20]);if(s){var o=s.length;for(var h=0;h<o;h++){var l=s[h];if(!h){this.addPoint(l[0],l[1],true)}else{this.addPoint(l[0],l[1],false)}}}};CanvasRenderingContext2DWebGL.prototype.rect=function(t,e,r,a){var i=this.state.m;var n=mat2d.transformPointInt(i,t,e,0);var s=mat2d.transformPointInt(i,t+r,e,1);var o=mat2d.transformPointInt(i,t+r,e+a,2);var h=mat2d.transformPointInt(i,t,e+a,3);var l=this.canvasWidth;var u=this.canvasHeight;var f=this.canvasWidth10;var c=this.canvasHeight10;if(n.x<0&&s.x<0&&o.x<0&&h.x<0||n.y<0&&s.y<0&&o.y<0&&h.y<0||n.x>f&&s.x>f&&o.x>f&&h.x>f||n.y>c&&s.y>c&&o.y>c&&h.y>c){return}if(r>l+1||a>u+1){this.bigRect(n,s,o,h)}else{this.addPoint(n.x,n.y,true);this.addPoint(s.x,s.y,false);this.addPoint(o.x,o.y,false);this.addPoint(h.x,h.y,false);this.addPoint(n.x,n.y,false)}};CanvasRenderingContext2DWebGL.prototype.tesselateBezier=function(t,e,r,a,i,n,s,o,h,l){var u,f,c,g,v,d,p,m,y,b,x,C;var w,P,R,D;if(h>10)return;u=(t+r)*.5;f=(e+a)*.5;c=(r+i)*.5;g=(a+n)*.5;v=(i+s)*.5;d=(n+o)*.5;p=(u+c)*.5;m=(f+g)*.5;w=s-t;P=o-e;R=Math.abs((r-s)*P-(a-o)*w);D=Math.abs((i-s)*P-(n-o)*w);if((R+D)*(R+D)<this.tessTol*(w*w+P*P)){this.addPoint(s,o,l);return}y=(c+v)*.5;b=(g+d)*.5;x=(p+y)*.5;C=(m+b)*.5;this.tesselateBezier(t,e,u,f,p,m,x,C,h+1,0);this.tesselateBezier(x,C,y,b,v,d,s,o,h+1,l)};CanvasRenderingContext2DWebGL.prototype.doArcTo=function(t,e,r,a,i){var n={x:0,y:0};var s=this.lastX;var o=this.lastY;var h,l,u,f,c,g,v,d,p,m;var y=false;if(!this.hasPoint()){return}if(Math.ptEquals(s,o,t,e,this.distTol)||Math.ptEquals(t,e,r,a,this.distTol)||Math.distPtSeg(t,e,s,o,r,a)<this.distTol*this.distTol||i<this.distTol){this.addPoint(t,e,false);return}h=s-t;l=o-e;u=r-t;f=a-e;Math.normalize(h,l,n);h=n.x;l=n.y;Math.normalize(u,f,n);u=n.x;f=n.y;c=Math.acos(h*u+l*f);g=i/Math.tan(c/2);if(g>1e4){this.addPoint(t,e,false);return}if(Math.cross(h,l,u,f)>0){v=t+h*g+l*i;d=e+l*g+-h*i;p=Math.atan2(h,-l);m=Math.atan2(-u,f);y=false}else{v=t+h*g+-l*i;d=e+l*g+h*i;p=Math.atan2(-h,l);m=Math.atan2(u,-f);y=true}this.doArc(v,d,i,p,m,y)};CanvasRenderingContext2DWebGL.prototype.doArc=function(t,e,r,a,i,n){var s=0,o=0,h=0,l=0;var u=0,f=0,c=0,g=0,v=0,d=0;var p=0,m=0,y=0,b=0;var x=new Array(3+5*7+100);var C,w,P;var R=!this.hasPoint();o=i-a;if(!n){if(Math.abs(o)>=Math.PI*2){o=Math.PI*2}else{while(o<0)o+=Math.PI*2}}else{if(Math.abs(o)>=Math.PI*2){o=-Math.PI*2}else{while(o>0)o-=Math.PI*2}}w=Math.floor(Math.max(1,Math.min(Math.abs(o)/(Math.PI*.5)+.5,5)));h=o/w/2;l=Math.abs(4/3*(1-Math.cos(h))/Math.sin(h));if(n){l=-l}P=0;for(C=0;C<=w;C++){s=a+o*(C/w);u=Math.cos(s);f=Math.sin(s);c=t+u*r;g=e+f*r;v=-f*r*l;d=u*r*l;if(C==0){this.addPoint(c,g,R)}else{this.bezierTo(p+y,m+b,c-v,g-d,c,g)}p=c;m=g;y=v;b=d}return};CanvasRenderingContext2DWebGL.prototype.quadTo=function(t,e,r,a){var i=this.lastX;var n=this.lastY;var s=i+2/3*(t-i);var o=n+2/3*(e-n);var h=r+2/3*(t-r);var l=a+2/3*(e-a);this.bezierTo(s,o,h,l,r,a)};CanvasRenderingContext2DWebGL.prototype.bezierTo=function(t,e,r,a,i,n){this.tesselateBezier(this.lastX,this.lastY,t,e,r,a,i,n,0,0)};CanvasRenderingContext2DWebGL.prototype.quadraticCurveTo=function(t,e,r,a){var i=this.state.m;var n=mat2d.transformPointInt(i,t,e,0);var s=mat2d.transformPointInt(i,r,a,1);this.quadTo(n.x,n.y,s.x,s.y)};CanvasRenderingContext2DWebGL.prototype.bezierCurveTo=function(t,e,r,a,i,n){var s=this.state.m;var o=mat2d.transformPointInt(s,t,e,0);var h=mat2d.transformPointInt(s,r,a,1);var l=mat2d.transformPointInt(s,i,n,2);this.bezierTo(o.x,o.y,h.x,h.y,l.x,l.y)};CanvasRenderingContext2DWebGL.prototype.arcTo=function(t,e,r,a,i){var n=this.state.m;var s=i*10>>0;var o=mat2d.transformPointInt(n,t,e,0);var h=mat2d.transformPointInt(n,r,a,1);this.doArcTo(o.x,o.y,h.x,h.y,s)};CanvasRenderingContext2DWebGL.prototype.arc=function(t,e,r,a,i,n){var s=r*10>>0;var o=this.state.m;var h=mat2d.transformPointInt(o,t,e);var l=this.canvasWidth10;var u=this.canvasHeight10;if(h.x-s>l||h.x+s<0||h.y-s>u||h.y+s<0){return}this.doArc(h.x,h.y,s,a,i,n)};CanvasRenderingContext2DWebGL.getWebGLContext=function(t,e){var r=null;var a=["webgl","experimental-webgl","webkit-3d","moz-webgl"];var i=e||CanvasRenderingContext2DWebGL.webglOptions;for(var n=0;n<a.length;n++){try{r=t.getContext(a[n],i)}catch(s){}if(r){break}}return r};CanvasRenderingContext2DWebGL.prototype.initGL=function(t){var e=CanvasRenderingContext2DWebGL.getWebGLContext(t,this.webglOptions);e.w=t.width;e.h=t.height;e.enable(e.BLEND);e.enable(e.STENCIL_TEST);e.disable(e.DEPTH_TEST);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);this.gl=e;this.canvas=t;this.buffer=e.createBuffer();WebGLProgramDrawImage.init(e,this.buffer);this.drawPrimitivesProgram=new WebGLProgramDrawPrimitives(e,this.buffer);return e};CanvasRenderingContext2DWebGL.prototype.isPOT=function(t){return t>0&&(t&t-1)===0};CanvasRenderingContext2DWebGL.prototype.loadTextureWithImage=function(t){if(t.texture||!t.width){return t}var e=this.gl;var r=e.createTexture();e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,true);t.texture=r;t.ox=0;t.oy=0;r.w=t.width;r.h=t.height;r.src=t.src;e.bindTexture(e.TEXTURE_2D,r);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);if(this.isPOT(t.width)&&this.isPOT(t.height)){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)}else{e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}e.bindTexture(e.TEXTURE_2D,null);return t};CanvasRenderingContext2DWebGL.prototype.drawImageBatch=function(t,e,r){this.drawCalls++;this.drawImageCalls++;e.draw(t,r)};CanvasRenderingContext2DWebGL.prototype.beginFrame=function(){var t=this.gl;var e=this.getWidth();var r=this.getHeight();var a=this.canvas;this.drawCalls=0;this.drawImageCalls=0;this.drawImageCount=0;this.fillCount=0;this.strokeCount=0;this.clipLevel=0;this.canvasWidth=e;this.canvasHeight=r;this.canvasWidth10=e*10;this.canvasHeight10=r*10;if(t.w!==e||t.h!==r){t.w=e;t.h=r;t.clearColor(1,1,1,1);t.viewport(0,0,a.width,a.height)}if(this.showFPS){this.renderTimes++;this.startTime=Date.now();this.thisSeconds=this.startTime/1e3>>0;if(this.thisSeconds!==this.lastSeconds){this.fps=this.renderTimes;this.lastSeconds=this.thisSeconds;this.renderTimes=0}}if(this.webglOptions.preserveDrawingBuffer){t.clear(t.STENCIL_BUFFER_BIT)}else{t.clear(t.STENCIL_BUFFER_BIT|t.COLOR_BUFFER_BIT)}this.lastX=0;this.lastY=0;this.firstX=0;this.firstY=0;this.lineWidth=1;this.globalAlpha=1;this.globalTint=1;this.textAlign="left";mat2d.identity(this.state.m);this.textBaseline="middle";this.globalImageFilter="normal";this.state.fillStyle=CanvasRenderingContext2DWebGL.fillStyle;this.state.strokeStyle=CanvasRenderingContext2DWebGL.strokeStyle;this.stencilColor=CanvasRenderingContext2DWebGL.stencilColor;this.globalCompositeOperation="source-over";this.beginPath();if(this.autoPacker.isOverflow()){this.autoPacker.reset()}};CanvasRenderingContext2DWebGL.prototype.drawStat=function(t){this.save();this.fillStyle=this.statusBgColor;this.fillRect(0,0,280,35);var e=t+" images("+this.drawImageCount+"/"+this.drawImageCalls+") calls:"+this.drawCalls;this.font=this.statusFont;this.fillStyle=this.statusFontColor;this.textBaseline="top";this.textAlign="left";this.fillText(e,5,5);this.restore();return};CanvasRenderingContext2DWebGL.prototype.onEndFrame=function(){if(this.showFPS){var t=this.fps;this.drawStat(t)}};CanvasRenderingContext2DWebGL.prototype.endFrame=function(){var t=this.stack.length;if(t>0){for(var e=0;e<t;e++){this.restore()}console.log("restore times < save times.")}mat2d.identity(this.state.m);this.globalAlpha=1;this.globalTint=1;this.globalCompositeOperationApply("source-over");this.onEndFrame();this.commitDrawImage()};CanvasRenderingContext2DWebGL.colors={};CanvasRenderingContext2DWebGL.parseColor=function(t){var e=CanvasRenderingContext2DWebGL.colors[t];if(e){return e}var r=t||"white";var a=cs.get(r.toLowerCase());if(!a){a=cs.get("white")}var i=a.value;var n={r:i[0]/255,g:i[1]/255,b:i[2]/255,a:i[3],str:t};CanvasRenderingContext2DWebGL.colors[t]=n;return n};CanvasRenderingContext2DWebGL.State=function(){this.font="16px sans";this.lineWidth=1;this.globalAlpha=1;this.globalTint=1;this.m=mat2d.create();this.clipRect=null;this.clipPaths=null;this.textAlign="left";this.textBaseline="middle";this.globalImageFilter="normal";this.globalCompositeOperation="source-over";this.fillStyle=CanvasRenderingContext2DWebGL.fillStyle;this.strokeStyle=CanvasRenderingContext2DWebGL.strokeStyle};CanvasRenderingContext2DWebGL.createState=function(){if(CanvasRenderingContext2DWebGL.stateCache.length){return CanvasRenderingContext2DWebGL.stateCache.pop()}else{return new CanvasRenderingContext2DWebGL.State}};CanvasRenderingContext2DWebGL.stateCache=[];CanvasRenderingContext2DWebGL.destroyState=function(t){if(t.clipRect){t.clipRect=null}if(t.clipPaths){t.clipPaths=null}CanvasRenderingContext2DWebGL.stateCache.push(t)};CanvasRenderingContext2DWebGL.State.prototype.clone=function(){var t=CanvasRenderingContext2DWebGL.createState();if(this.clipRect){t.clipRect=this.clipRect}if(this.clipPaths){t.clipPaths=this.clipPaths}mat2d.copy(t.m,this.m);t.font=this.font;t.lineWidth=this.lineWidth;t.textAlign=this.textAlign;t.fillStyle=this.fillStyle;t.strokeStyle=this.strokeStyle;t.textBaseline=this.textBaseline;t.globalTint=this.globalTint;t.globalAlpha=this.globalAlpha;t.globalImageFilter=this.globalImageFilter;t.globalCompositeOperation=this.globalCompositeOperation;return t};CanvasRenderingContext2DWebGL.prototype.init=function(t){this.stack=[];this.state=CanvasRenderingContext2DWebGL.createState();this.initGL(t);this.lastUpdateTime=Date.now();var e=WebGLProgramDrawImage.get();this.drawImageQueue={};this.drawImageQueue.globalAlpha=256;this.drawImageQueue.globalCompositeOperation=0;this.drawImageQueue.dataBuffer=e.createDataBuffer(20*1024);this.drawPrimitiveQueue={};this.drawPrimitiveQueue.paths=Int16Array.create(1024);this.drawPrimitiveQueue.dataBuffer=this.drawPrimitivesProgram.createDataBuffer(20*1024);this.autoPacker=new AutoPacker;this.autoPacker.init(this.gl);this.statusFont="20px sans";this.statusFontColor="Green";this.statusBgColor="rgba(0,0,0,1)";return this};CanvasRenderingContext2DWebGL.prototype.ensureCtx2d=function(){if(this.ctx2d){return}this.canvas2d=document.createElement("canvas");this.ctx2d=this.canvas2d.getContext("2d")};CanvasRenderingContext2DWebGL.prototype.measureText=function(t){this.ensureCtx2d();this.ctx2d.font=this.font;return this.ctx2d.measureText(t)};CanvasRenderingContext2DWebGL.prototype.setShowFPS=function(t){this.showFPS=t};CanvasRenderingContext2DWebGL.create=function(t,e){var r=new CanvasRenderingContext2DWebGL(e);CanvasRenderingContext2DWebGL.fillStyle=CanvasRenderingContext2DWebGL.parseColor("white");CanvasRenderingContext2DWebGL.strokeStyle=CanvasRenderingContext2DWebGL.parseColor("black");CanvasRenderingContext2DWebGL.stencilColor=CanvasRenderingContext2DWebGL.parseColor("white");return r.init(t)};HTMLCanvasElement.prototype.getContextOrg=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=function(t,e){if(this.webglCtx){return this.webglCtx}if(t==="2d-webgl"){if(!this.webglCtx){this.webglCtx=CanvasRenderingContext2DWebGL.create(this,e)}return this.webglCtx}else{return HTMLCanvasElement.prototype.getContextOrg.call(this,t,e)}};

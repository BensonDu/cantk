function UIParticlesX(){return}UIParticlesX.prototype=new UIElement;UIParticlesX.prototype.isUIParticlesX=true;UIParticlesX.prototype.saveProps=["dataURL","textureURL"];UIParticlesX.prototype.initUIParticlesX=function(t){this.initUIElement(t);this.name="ui-particles";this.autoEmit=true;this.paused=false;this.setDefSize(200,200);this.setTextType(Shape.TEXT_NONE);this.setImage(UIElement.IMAGE_DEFAULT,null);this.images.display=UIElement.IMAGE_DISPLAY_CENTER;return this};UIParticlesX.prototype.setEmitterPosition=function(t,i){return this};UIParticlesX.prototype.onFromJsonDone=function(){return this};UIParticlesX.prototype.emit=function(t){this.particles.emit(t);return this};UIParticlesX.prototype.start=function(){this.particles.reset();return this};UIParticlesX.prototype.stop=function(){this.particles.stop();return this};UIParticlesX.prototype.pause=function(){this.paused=true;return this};UIParticlesX.prototype.resume=function(){this.paused=false;return this};UIParticlesX.prototype.loadPList=function(t,i){this.particles=new ParticleEmitter;this.particles.init(t);this.particles.setTexture(i);return};UIParticlesX.prototype.onInit=function(){var t=this;var i=null;if(this.dataURL){ResLoader.loadData(this.dataURL,function(e){try{i=JSON.parse(e)}catch(a){var r=new PList;i=r.parse(e);if(i.textureFileName){t.textureURL=t.dataURL.substring(0,t.dataURL.lastIndexOf("/")+1)+i.textureFileName}}delete t.particles;var s=i.imageData||t.textureURL;if(s){ResLoader.loadImage(s,function(e){if(e.width===0||e.height===0){console.debug("particlesx invalid img");return}t.loadPList(i,e)})}})}return};UIParticlesX.prototype.drawBgImage=function(){return};UIParticlesX.prototype.setDataURL=function(t){if(t===this.dataURL||!t)return;this.dataURL=t;if(/\.json$/.test(t)){this.saveProps=["dataURL"]}else{this.textureURL=t.substring(0,t.lastIndexOf(".")+1)+"png"}this.onInit()};UIParticlesX.prototype.getDataURL=function(){return this.dataURL};UIParticlesX.prototype.drawParticle=function(t){var i=this.timeScaleIsZero()||this.paused||this.isInDesignMode()&&this.disablePreview;if(!i){this.particles.update(t.timeStep/1e3)}this.particles.setScaleX(this.scaleX);this.particles.setScaleY(this.scaleY);this.particles.draw(t)};UIParticlesX.prototype.paintSelfOnly=function(t){if(this.particles){t.needRedraw++;t.save();t.translate(this.w/2,this.h/2);this.drawParticle(t);t.restore()}return};UIParticlesX.prototype.shapeCanBeChild=function(t){return false};function UIParticlesXCreator(){var t=["ui-particles-x","ui-particles-x",null,1];ShapeCreator.apply(this,t);this.createShape=function(t){var i=new UIParticlesX;return i.initUIParticlesX(this.type)};return}ShapeFactoryGet().addShapeCreator(new UIParticlesXCreator);void function(){function t(t,i){t.x*=i;t.y*=i}function i(t,i){t.x=i.x;t.y=i.y}function e(t,i){t.x+=i.x;t.y+=i.y}function a(t,i){t.x-=i.x;t.y-=i.y}function r(i){t(i,1/Math.sqrt(i.x*i.x+i.y*i.y))}function s(t){t.x=0;t.y=0}function o(t,i){if(!(this instanceof o)){return new o(t,i)}this.x=t;this.y=i}function n(t,i,e,a){if(!(this instanceof n)){return new n(t,i,e,a)}this.r=t;this.g=i;this.b=e;this.a=a}function h(t,i,e,a){if(!(this instanceof h)){return new h(t,i,e,a)}this.x=t;this.y=i;this.w=e;this.h=a}function l(t,i){var e=t.x,a=t.y,r=i.a,s=i.b,o=i.c,n=i.d,h=i.tx,l=i.ty;return{x:r*e+o*a+h,y:s*e+n*a+l}}var c=Math.PI/180;function p(t){return c*t}function d(){return(Math.random()-.5)*2}function u(t,i,e){if(i>e){var a=i;i=e;e=i}return t<i?i:t>e?e:t}var f=1;var m=770;var P=771;function y(){this.pos=o(0,0);this.startPos=o(0,0);this.drawPos=o(0,0);this.color=n(0,0,0,255);this.deltaColor=n(0,0,0,255);this.modeA=new y.ParamsGravity;this.modeB=new y.ParamsRadius;this.size=0;this.deltaSize=0;this.rotation=0;this.deltaRotation=0;this.timeToLive=0;this.isChangeColor=false}y.TemporaryPoints=[o(0,0),o(0,0),o(0,0),o(0,0)];y.ModeGravity=function(t,i,e,a,r,s,o,n,h){this.speed=t;this.speedVar=i;this.gravity={x:e,y:a};this.radialAccel=r;this.radialAccelVar=s;this.tangentialAccel=o;this.tangentialAccelVar=n;this.rotationIsDir=h};y.ModeGravity.prototype.randomFeatures=function(i,e){var a=e.modeA;var r=this.speed+this.speedVar*d();a.dir.x=Math.cos(i);a.dir.y=Math.sin(i);t(a.dir,r);a.radialAccel=this.radialAccel+this.radialAccelVar*d();a.tangentialAccel=this.tangentialAccel+this.tangentialAccelVar*d()};y.ParamsGravity=function(t,i,e){this.dir=t||o(0,0);this.radialAccel=i;this.tangentialAccel=e};y.ModeRadius=function(t,i,e,a,r,s){this.startRadius=t;this.startRadiusVar=i;this.endRadius=e;this.endRadiusVar=a;this.rotatePerSecond=r;this.rotatePerSecondVar=s};y.ModeRadius.prototype.randomFeatures=function(t,i){var e=i.modeB;var a=this.startRadius+this.startRadiusVar*d();var r=this.endRadius+this.endRadiusVar*d();e.angle=t;e.radius=a;e.deltaRadius=(r-a)/i.timeToLive;e.anglePerSecond=p(this.rotatePerSecond+this.rotatePerSecondVar*d())};y.ParamsRadius=function(t,i,e,a){this.angle=t;this.radius=e||0;this.deltaRadius=a||0;this.anglePerSecond=i||0};function v(t){this.emitMode=0;this.duration=0;this.emitRate=0;this.timeCounter=0;this.srcPos=o(0,0);this.srcPosVar=o(0,0);this.angle=0;this.angleVar=0;this.maxParticles=0;this.isRemoveOnFinish=false;this.particles=[];this.particleCounter=0;this.positionType=v.POS_TYPE_FREE;this.srcBlendFunc=0;this.dstBlendFunc=0;this.life=0;this.lifeVar=0;this.startSize=0;this.startSizeVar=0;this.endSize=0;this.endSizeVar=0;this.startColor=n(0,0,0,0);this.startColorVar=n(0,0,0,0);this.endColor=n(0,0,0,0);this.endColorVar=n(0,0,0,0);this.startSpin=0;this.startSpinVar=0;this.endSpin=0;this.endSpinVar=0;this.tmpZeroPoint=o(0,0);this.elapsed=0;this.timeScale=1;this.active=true;this.texture=null;this.scaleX=1;this.scaleY=1;this.transform={a:1,b:0,c:0,d:1,tx:0,ty:0};this.worldTransform={a:1,b:0,c:0,d:1,tx:0,ty:0};this.anchorPointInPoints=o(0,0)}v.POS_TYPE_FREE=0;v.POS_TYPE_RELATIVE=1;v.POS_TYPE_GROUPED=2;v.MODE_GRAVITY=0;v.MODE_RADIUS=1;v.MODE_WIND=2;function g(t,i,e){return t[i]!=void 0?t[i]:e}function C(t,i){var e=t.width;var a=t.height;i[0].width=e;i[0].height=a;i[1].width=e;i[1].height=a;i[2].width=e;i[2].height=a;i[3].width=e;i[3].height=a;var r=i[3].getContext("2d");r.drawImage(t,0,0);var s=r.getImageData(0,0,e,a).data;var o;for(var n=0;n<4;n++){o=i[n].getContext("2d");var h=o.getImageData(0,0,e,a);var l=h.data;for(var c=0;c<s.length;c+=4){l[c]=n===0?s[c]:0;l[c+1]=n===1?s[c+1]:0;l[c+2]=n===2?s[c+2]:0;l[c+3]=s[c+3]}o.putImageData(h,0,0)}t.onload=null}v.prototype.parseModeGravity=function(t){return new y.ModeGravity(parseFloat(g(t,"speed")),parseFloat(g(t,"speedVariance")),parseFloat(g(t,"gravityx")),parseFloat(g(t,"gravityy")),parseFloat(g(t,"radialAcceleration")),parseFloat(g(t,"radialAccelVariance")),parseFloat(g(t,"tangentialAcceleration")),parseFloat(g(t,"tangentialAccelVariance")),g(t,"rotationIsDir",false))};v.prototype.parseModeRadius=function(t){return new y.ModeRadius(parseFloat(g(t,"maxRadius")),parseFloat(g(t,"maxRadiusVariance")),parseFloat(g(t,"minRadius")),0,parseFloat(g(t,"rotatePerSecond")),parseFloat(g(t,"rotatePerSecondVariance")))};v.prototype.init=function(t){this.maxParticles=parseInt(g(t,"maxParticles",0));for(var i=0;i<this.maxParticles;i++){this.particles.push(new y)}this.angle=parseInt(g(t,"angle",0));this.angleVar=parseInt(g(t,"angleVariance",0));this.duration=parseInt(g(t,"duration",0));this.backDuration=this.duration;this.srcBlendFunc=parseInt(g(t,"blendFuncSource",0));this.dstBlendFunc=parseInt(g(t,"blendFuncDestination",0));this.startColor.r=parseFloat(g(t,"startColorRed"))*255;this.startColor.g=parseFloat(g(t,"startColorGreen"))*255;this.startColor.b=parseFloat(g(t,"startColorBlue"))*255;this.startColor.a=parseFloat(g(t,"startColorAlpha"))*255;this.startColorVar.r=parseFloat(g(t,"startColorVarianceRed"))*255;this.startColorVar.g=parseFloat(g(t,"startColorVarianceGreen"))*255;this.startColorVar.b=parseFloat(g(t,"startColorVarianceBlue"))*255;this.startColorVar.a=parseFloat(g(t,"startColorVarianceAlpha"))*255;this.endColor.r=parseFloat(g(t,"finishColorRed"))*255;this.endColor.g=parseFloat(g(t,"finishColorGreen"))*255;this.endColor.b=parseFloat(g(t,"finishColorBlue"))*255;this.endColor.a=parseFloat(g(t,"finishColorAlpha"))*255;this.endColorVar.r=parseFloat(g(t,"finishColorVarianceRed"))*255;this.endColorVar.g=parseFloat(g(t,"finishColorVarianceGreen"))*255;this.endColorVar.b=parseFloat(g(t,"finishColorVarianceBlue"))*255;this.endColorVar.a=parseFloat(g(t,"finishColorVarianceAlpha"))*255;this.startSize=parseFloat(g(t,"startParticleSize"));this.startSizeVar=parseFloat(g(t,"startParticleSizeVariance"));this.endSize=parseFloat(g(t,"finishParticleSize"));this.endSizeVar=parseFloat(g(t,"finishParticleSizeVariance"));this.srcPos.x=parseFloat(g(t,"sourcePositionx"));this.srcPos.y=parseFloat(g(t,"sourcePositiony"));this.srcPosVar.x=parseFloat(g(t,"sourcePositionVariancex"));this.srcPosVar.y=parseFloat(g(t,"sourcePositionVariancey"));this.startSpin=parseFloat(g(t,"rotationStart"));this.startSpinVar=parseFloat(g(t,"rotationStartVariance"));this.endSpin=parseFloat(g(t,"rotationEnd"));this.endSpinVar=parseFloat(g(t,"rotationEndVariance"));this.life=parseFloat(g(t,"particleLifespan"));this.lifeVar=parseFloat(g(t,"particleLifespanVariance"));this.emitRate=this.maxParticles/this.life;this.isRemoveOnFinish=g(t,"isAutoRemoveOnFinish",false);this.emitMode=parseFloat(g(t,"emitterType"));this.imageData=g(t,"imageData",null)||g(t,"textureImageData",null);if(this.imageData){var e=new Image;e.src=this.imageData;this.setTexture(e)}if(this.emitMode===v.MODE_GRAVITY){this.mode=this.parseModeGravity(t)}else{this.mode=this.parseModeRadius(t)}};v.prototype.setScaleX=function(t){this.scaleX=t;return this};v.prototype.setScaleY=function(t){this.scaleY=t;return this};v.prototype.emit=function(t){this.reset();if(t){if("backDuration"in this){this.duration=this.backDuration}if(this.duration===-1){this.duration=1}}else{if("backDuration"in this){this.backDuration=this.duration}this.duration=-1}};v.prototype.reset=function(){this.active=true;this.elapsed=0;if("backDuration"in this){this.duration=this.backDuration}var t=this.particles;for(var i=0;i<t.length;i++){t[i].timeToLive=0}};v.prototype.reload=function(t){this.stop();this.init(t);this.start()};v.prototype.pause=function(){this.timeScale=0;return this};v.prototype.resume=function(){this.timeScale=1;return this};v.prototype.start=function(){this.reset();return this};v.prototype.stop=function(){if("backDuration"in this){this.duration=this.backDuration}this.active=false;this.elapsed=this.duration;this.timeCounter=0;return this};v.prototype.setTexture=function(t){if(t===this.texture)return;this.texture=t;this.textureRect=h(0,0,t.width,t.height);return this};v.prototype.getWorldTransform=function(){var t=this.transform;var i=1,e=0,a=0,r=1;t.tx=this.srcPos.x;t.ty=this.srcPos.y;t.a=i;t.b=e;t.c=a;t.d=r;var s=this.scaleX,o=this.scaleY;var n=this.anchorPointInPoints.x,h=this.anchorPointInPoints.y;s=s<1e-6&&s>-1e-6?1e-6:s;o=o<1e-6&&o>-1e-6?1e-6:o;if(s!==1||o!==1){i=t.a*=s;e=t.b*=s;a=t.c*=o;r=t.d*=o}t.tx-=i*n+a*h;t.ty-=e*n+r*h;return this.transform};v.prototype.convertToWorldSpace=function(t){return l(t,this.getWorldTransform())};v.prototype.initParticle=function(t){t.timeToLive=this.life+this.lifeVar*d();t.timeToLive=Math.max(0,t.timeToLive);t.pos.x=this.srcPosVar.x*d();t.pos.y=this.srcPosVar.y*d();var i={r:u(this.startColor.r+this.startColorVar.r*d(),0,255),g:u(this.startColor.g+this.startColorVar.g*d(),0,255),b:u(this.startColor.b+this.startColorVar.b*d(),0,255),a:u(this.startColor.a+this.startColorVar.a*d(),0,255)};var e={r:u(this.endColor.r+this.endColorVar.r*d(),0,255),g:u(this.endColor.g+this.endColorVar.g*d(),0,255),b:u(this.endColor.b+this.endColorVar.b*d(),0,255),a:u(this.endColor.a+this.endColorVar.a*d(),0,255)};t.color=i;t.deltaColor={r:(e.r-i.r)/t.timeToLive,g:(e.g-i.g)/t.timeToLive,b:(e.b-i.b)/t.timeToLive,a:(e.a-i.a)/t.timeToLive};var a=this.startSize+this.startSizeVar*d();var r=this.endSize+this.endSizeVar*d();t.size=Math.max(0,a);t.deltaSize=(r-a)/t.timeToLive;var s=this.startSpin+this.startSpinVar*d();var o=this.endSpin+this.endSpinVar*d();t.rotation=s;t.deltaRotation=(o-s)/t.timeToLive;if(this.positionType===v.POS_TYPE_FREE){t.startPos=this.convertToWorldSpace(this.tmpZeroPoint)}else if(this.positionType===v.POS_TYPE_RELATIVE){t.startPos.x=this.srcPos.x;t.startPos.y=this.srcPos.y}var n=p(this.angle+this.angleVar*d());this.mode.randomFeatures(n,t)};v.prototype.isFull=function(){return this.particleCounter>=this.maxParticles};v.prototype.addParticle=function(){if(!this.isFull()){var t=null;if(this.particleCounter<this.particles.length){t=this.particles[this.particleCounter]}else{t=new y;this.particles.push(t)}this.initParticle(t);++this.particleCounter}};v.prototype.updateParticles=function(o){var n=y.TemporaryPoints[0];if(this.positionType===v.POS_TYPE_FREE){i(n,this.convertToWorldSpace(this.tmpZeroPoint))}else if(this.positionType===v.TYPE_RELATIVE){n.x=this.srcPos.x;n.y=this.srcPos.y}var h=null,l=0,c=this.particles,p=y.TemporaryPoints[1],d=y.TemporaryPoints[2],u=y.TemporaryPoints[3];while(l<this.particleCounter){s(p);s(d);s(u);h=c[l];h.timeToLive-=o;if(h.timeToLive>0){if(this.emitMode===v.MODE_GRAVITY){var f=u,m=p,P=d;if(h.pos.x||h.pos.y){i(m,h.pos);r(m)}else{s(m)}i(P,m);t(m,h.modeA.radialAccel);var g=P.x;P.x=-P.y;P.y=g;t(P,h.modeA.tangentialAccel);i(f,m);e(f,P);e(f,this.mode.gravity);t(f,o);e(h.modeA.dir,f);i(f,h.modeA.dir);t(f,o);e(h.pos,f)}else{var C=h.modeB;C.angle+=C.anglePerSecond*o;C.radius+=C.deltaRadius*o;h.pos.x=-Math.cos(C.angle)*C.radius;h.pos.y=-Math.sin(C.angle)*C.radius}h.color.r+=h.deltaColor.r*o;h.color.g+=h.deltaColor.g*o;h.color.b+=h.deltaColor.b*o;h.color.a+=h.deltaColor.a*o;h.isChangeColor=false;h.size+=h.deltaSize*o;h.size=Math.max(0,h.size);h.rotation+=h.deltaRotation*o;var x=p;if(this.positionType===v.POS_TYPE_FREE||this.positionType===v.POS_TYPE_RELATIVE){var V=d;i(V,n);a(V,h.startPos);i(x,h.pos);a(x,V)}else{i(x,h.pos)}i(h.drawPos,x);++l}else{if(l!==this.particleCounter-1){var S=c[l]=c[this.particleCounter-1];c[this.particleCounter-1]=h}--this.particleCounter}}return};v.prototype.update=function(t){var i=1/this.emitRate;t*=this.timeScale;if(this.active){if(this.particleCounter<this.maxParticles){this.timeCounter+=t}while(this.particleCounter<this.maxParticles&&this.timeCounter>i){this.addParticle();this.timeCounter-=i}this.elapsed+=t;if(this.duration!==-1&&this.duration<=this.elapsed){this.stop()}}this.updateParticles(t)};v.prototype.setTransform=function(t,i){t.transform(i.a,-i.b,-i.c,i.d,i.tx*this.scaleX,-(i.ty*this.scaleY))};v.prototype.isBlendAdditive=function(){return this.srcBlendFunc===m&&this.dstBlendFunc===f||this.srcBlendFunc===f&&this.dstBlendFunc===f};v.prototype.changeTextureColor=function(t,i,e){if(!this.tintCache){this.tintCache=document.createElement("canvas")}var a=this.tintCache;var r=a.getContext("2d");a.width=t.width;a.height=t.height;r.globalCompositeOperation="source-over";r.fillStyle="rgb("+(i.r|0)+","+(i.g|0)+","+(i.b|0)+")";r.fillRect(0,0,e.w,e.h);r.globalCompositeOperation="multiply";r.drawImage(t,e.x,e.y,e.w,e.h,0,0,e.w,e.h);r.globalCompositeOperation="destination-atop";r.drawImage(t,e.x,e.y,e.w,e.h,0,0,e.w,e.h);return a};v.prototype.draw=function(t){var i=this.texture,e=this.particles,a=this.textureRect,r=this.particleCounter;t.save();this.setTransform(t,this.worldTransform);if(this.isBlendAdditive()){t.globalCompositeOperation="lighter"}else{t.globalCompositeOperation="source-over"}var s,o,n,h,l=a.w,c=a.h;for(var d=0;d<r;d++){s=e[d];o=0|s.size*.5;n=s.color.a/255;if(n===0)continue;t.globalAlpha=n;t.save();t.translate(0|s.drawPos.x,-(0|s.drawPos.y));h=Math.floor(s.size/4)*4;t.scale(Math.max(1/l*h,1e-6),Math.max(1/c*h,1e-6));if(s.rotation){t.rotate(p(s.rotation))}var u=s.isChangeColor?this.changeTextureColor(i,s.color,a):i;t.drawImage(u,-(0|l/2),-(0|c/2));t.restore()}t.restore()};window.ParticleEmitter=v}();
